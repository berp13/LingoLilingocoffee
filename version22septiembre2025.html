<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CoffeeTalk English â€” Aprender en la cafeterÃ­a</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent: #E97E2E;
        }
        body {
            font-family: 'Poppins', sans-serif;
        }
        .coffee-bg {
            background-image: url('https://i.pinimg.com/originals/7c/14/c2/7c14c2039281a755662f9b234287156b.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        .card {
            box-shadow: 0 6px 18px rgba(30, 30, 30, 0.05);
        }
        .btn-accent {
            background: var(--accent);
            box-shadow: 0 6px 10px rgba(233, 126, 46, 0.12);
        }
        .btn-muted {
            border: 1px solid rgba(233, 126, 46, 0.12);
        }
        .progress-bar-fill {
            background: linear-gradient(90deg, var(--accent), #B35C24);
        }
        /* Custom styles for quiz feedback */
        .quiz-choice.correct {
            border-color: rgba(60, 179, 113, 0.5); /* MediumSeaGreen with opacity */
            background-color: rgba(144, 238, 144, 0.15); /* LightGreen with opacity */
        }
        .quiz-choice.wrong {
            border-color: rgba(255, 99, 71, 0.5); /* Tomato with opacity */
            background-color: rgba(255, 182, 193, 0.15); /* LightPink with opacity */
        }
        .hidden { display: none; }
    </style>
</head>
<body class="coffee-bg min-h-screen">
    <div class="app max-w-4xl mx-auto p-5 md:p-10">
        <!-- Header -->
        <header class="flex items-center gap-4 mb-8">
            <div>
                <h1 class="text-3xl lg:text-4xl text-center font-extrabold text-white">Â¡Bienvenidos al templo del saber, Baristas BilingÃ¼es!</h1>
            </div>
        </header>

        <!-- Level Progress Bar -->
        <div id="levelProgressBar" class="mb-8">
            <div class="text-sm font-semibold text-white mb-2">Nivel <span id="levelText">1</span> de 100</div>
            <div class="h-2 bg-gray-100 rounded-full overflow-hidden">
                <div id="levelProgressFill" class="h-full w-0 progress-bar-fill transition-all duration-300 ease-out"></div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <main class="grid grid-cols-1">
            <!-- Start/Initial View -->
            <div id="startView">
                <section class="card bg-white p-8 rounded-3xl text-center flex flex-col items-center">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Â¡Comienza tu prÃ¡ctica diaria!</h2>
                    <p class="text-gray-500 mb-6">A continuaciÃ³n tendrÃ¡s 10 tarjetas con frases que debes aprender para responder las preguntas del cuestionario. EscÃºchalas cuantas veces lo necesites</p>
                    <button id="startButton" class="px-6 py-3 rounded-xl text-white font-semibold btn-accent transition-all duration-200 hover:opacity-90">Empezar</button>
                </section>
            </div>

            <!-- Flashcard View -->
            <div id="flashcardView" class="hidden">
                <section class="card bg-white p-5 rounded-3xl">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Tarjetas de Vocabulario</h2>
                    <p class="text-gray-500 mb-6">Escucha las frases y su traducciÃ³n para aprenderlas.</p>
                    <div id="cardGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Flashcards will be dynamically added here -->
                    </div>
                    <div class="text-center mt-6">
                        <button id="startQuizButton" class="px-6 py-3 rounded-xl text-white font-semibold btn-accent transition-all duration-200 hover:opacity-90">Comenzar Quiz</button>
                    </div>
                </section>
            </div>

            <!-- Quiz View -->
            <div id="quizView" class="hidden">
                <section class="card bg-white p-5 rounded-3xl">
                    <!-- Quiz Progress Info -->
                    <div class="flex justify-between items-center mb-4">
                        <div class="text-right">
                            <div class="text-sm font-semibold text-gray-500">Progreso del Quiz</div>
                            <div id="quizProgressText" class="text-lg font-bold text-orange-600">0/12</div>
                        </div>
                    </div>
                    <!-- Quiz Progress Bar -->
                    <div class="h-3 bg-gray-100 rounded-full overflow-hidden mb-8">
                        <div id="quizProgressFill" class="h-full w-0 progress-bar-fill transition-all duration-300 ease-out"></div>
                    </div>
                    <!-- Quiz Question -->
                    <div class="quiz card bg-gray-50 p-4 rounded-2xl">
                        <div class="flex justify-between items-center">
                            <strong class="text-gray-800">Pregunta <span id="currentQuestionNumber">1</span> de 12</strong>
                        </div>
                        <div id="quizQuestion" class="text-lg text-gray-700 mt-2">â€”</div>
                        <div class="choices flex flex-col gap-2 mt-3" id="choices"></div>
                    </div>
                </section>
            </div>

            <!-- Completion View -->
            <div id="completionView" class="hidden">
                <section class="card bg-white p-8 rounded-3xl text-center flex flex-col items-center">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4" id="completionTitle">Â¡LecciÃ³n completada!</h2>
                    <p class="text-gray-500 mb-6" id="completionMessage">Has terminado el quiz. Tu puntuaciÃ³n es: <span id="scoreDisplay" class="font-bold">0</span>/12.</p>
                    <button id="nextLevelButton" class="px-6 py-3 rounded-xl text-white font-semibold btn-accent transition-all duration-200 hover:opacity-90 mt-4">Continuar al siguiente nivel</button>
                    <button id="retryLevelButton" class="px-6 py-3 rounded-xl text-orange-600 bg-transparent font-semibold btn-muted transition-all duration-200 hover:bg-orange-50 mt-4 hidden">Intentar de nuevo</button>
                </section>
            </div>
        </main>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        setLogLevel('debug'); // Enable Firestore debug logging

        // The following variables are provided by the canvas environment. Do not modify.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const TOTAL_FLASHCARDS = 10;
        const TOTAL_QUIZ_QUESTIONS = 12;
        const TOTAL_LEVELS = 100;
        const PROGRESS_COLLECTION = 'coffeetalk_progress_v2';
        const REWARDS = {
            20: "Â¡Felicidades! Ganaste una Rebanada de pastel gratis.",
            40: "Â¡IncreÃ­ble! Has ganado un CafÃ© gratis.",
            60: "Â¡Sigue asÃ­! Tu premio es una Playera de la empresa.",
            80: "Â¡Genial! Has desbloqueado una Chapata gratis.",
            100: "Â¡Lo lograste! Puedes salir 30 minutos antes del trabajo."
        };

        const allPhrases = [
            // Difficulty 1-2: Simple, short phrases
            { en: 'A coffee, please.', es: 'Un cafÃ©, por favor.', difficulty: 1 },
            { en: 'I want a tea.', es: 'Quiero un tÃ©.', difficulty: 1 },
            { en: 'A small one.', es: 'Uno pequeÃ±o.', difficulty: 1 },
            { en: 'A large one.', es: 'Uno grande.', difficulty: 1 },
            { en: 'With milk.', es: 'Con leche.', difficulty: 1 },
            { en: 'With sugar.', es: 'Con azÃºcar.', difficulty: 1 },
            { en: 'To go.', es: 'Para llevar.', difficulty: 1 },
            { en: 'For here.', es: 'Para tomar aquÃ­.', difficulty: 1 },
            { en: 'Thank you.', es: 'Gracias.', difficulty: 1 },
            { en: 'Hello.', es: 'Hola.', difficulty: 1 },
            { en: 'How are you?', es: 'Â¿CÃ³mo estÃ¡s?', difficulty: 2 },
            { en: 'I am well.', es: 'Estoy bien.', difficulty: 2 },
            { en: 'Good morning.', es: 'Buenos dÃ­as.', difficulty: 2 },
            { en: 'Good afternoon.', es: 'Buenas tardes.', difficulty: 2 },
            { en: 'Good evening.', es: 'Buenas noches.', difficulty: 2 },

            // Difficulty 3-8: Slightly more complex, longer phrases
            { en: 'Can I have the menu?', es: 'Â¿Me das el menÃº?', difficulty: 3 },
            { en: 'What do you recommend?', es: 'Â¿QuÃ© me recomienda?', difficulty: 3 },
            { en: 'I would like a slice of cake.', es: 'Me gustarÃ­a una rebanada de pastel.', difficulty: 4 },
            { en: 'Could I get some water?', es: 'Â¿Me podrÃ­a traer un poco de agua?', difficulty: 4 },
            { en: 'I need to use the restroom.', es: 'Necesito usar el baÃ±o.', difficulty: 5 },
            { en: 'Can I pay with a card?', es: 'Â¿Puedo pagar con tarjeta?', difficulty: 5 },
            { en: 'Can I get the bill, please?', es: 'Â¿Me puedes traer la cuenta, por favor?', difficulty: 6 },
            { en: 'Where is the nearest table?', es: 'Â¿DÃ³nde estÃ¡ la mesa mÃ¡s cercana?', difficulty: 6 },
            { en: 'I ordered this to go.', es: 'PedÃ­ esto para llevar.', difficulty: 7 },
            { en: 'What kind of bread do you have?', es: 'Â¿QuÃ© tipo de pan tienen?', difficulty: 7 },
            { en: 'Is there a discount for students?', es: 'Â¿Hay algÃºn descuento para estudiantes?', difficulty: 8 },
            { en: 'I think you gave me the wrong order.', es: 'Creo que me diste el pedido equivocado.', difficulty: 8 },

            // Difficulty 9+: Long and complex sentences
            { en: 'I would like a large iced coffee with oat milk and a shot of vanilla, please.', es: 'Me gustarÃ­a un cafÃ© helado grande con leche de avena y un chorrito de vainilla, por favor.', difficulty: 9 },
            { en: 'Excuse me, I believe I was waiting for this table before those people arrived.', es: 'Disculpe, creo que yo estaba esperando esta mesa antes de que llegaran esas personas.', difficulty: 10 },
            { en: 'Is it possible to switch the type of coffee bean in my latte to a decaf roast?', es: 'Â¿Es posible cambiar el tipo de grano de cafÃ© en mi latte a un tueste descafeinado?', difficulty: 11 },
            { en: 'Could you please explain the different types of pastries you have available today?', es: 'Â¿PodrÃ­a por favor explicar los diferentes tipos de pasteles que tienen disponibles hoy?', difficulty: 12 },
            { en: 'I appreciate your help, but I think I will come back another day when it is not so busy.', es: 'Agradezco su ayuda, pero creo que volverÃ© otro dÃ­a cuando no estÃ© tan ocupado.', difficulty: 13 },
            { en: 'My apologies, I seem to have left my wallet at home. Is there any other way I can pay?', es: 'Mis disculpas, parece que dejÃ© mi billetera en casa. Â¿Hay alguna otra forma en que pueda pagar?', difficulty: 14 },
            { en: 'Could you please recommend a beverage that pairs well with the chocolate croissant?', es: 'Â¿PodrÃ­a recomendar una bebida que combine bien con el croissant de chocolate?', difficulty: 15 },
            
            // Level 100 phrases - Extreme Difficulty
            { en: 'Is the seasonal pumpkin spice latte crafted with real pumpkin puree or a flavoring syrup?', es: 'Â¿El latte de calabaza de temporada estÃ¡ elaborado con purÃ© de calabaza real o un jarabe de saborizante?', difficulty: 100 },
            { en: 'I am contemplating the ethereal distinction between the macchiato and the cortado on your menu.', es: 'Estoy contemplando la etÃ©rea distinciÃ³n entre el macchiato y el cortado en su menÃº.', difficulty: 100 },
            { en: 'Please elucidate the subtle and nuanced flavor profiles of your single-origin Ethiopian and Colombian roasts.', es: 'Por favor, elucide los sutiles y matizados perfiles de sabor de sus tuestes de origen Ãºnico de EtiopÃ­a y Colombia.', difficulty: 100 },
        ];
        
        // --- Helper function to shuffle an array
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- Core logic to generate phrases and quizzes for each level
        function getFlashcardPhrasesForLevel(level) {
            let selectedPhrases = [];
            let targetDifficulty;

            if (level === 12) {
                targetDifficulty = 1;
            } else if (level === 100) {
                targetDifficulty = 100;
            } else {
                targetDifficulty = Math.min(Math.floor(level / 3) + 1, allPhrases.length);
                if (level >= 9) {
                     targetDifficulty += 5; // Aumentar la dificultad de forma mÃ¡s significativa
                }
            }
            
            // Filter phrases by difficulty range
            const filteredPhrases = allPhrases.filter(phrase => 
                (phrase.difficulty >= targetDifficulty && phrase.difficulty <= targetDifficulty + 4) ||
                (level === 12 && phrase.difficulty === 1) ||
                (level === 100 && phrase.difficulty === 100)
            );

            // If not enough phrases, grab some random ones
            if (filteredPhrases.length < TOTAL_FLASHCARDS) {
                while(selectedPhrases.length < TOTAL_FLASHCARDS) {
                    const randomPhrase = allPhrases[Math.floor(Math.random() * allPhrases.length)];
                    if (!selectedPhrases.includes(randomPhrase)) {
                        selectedPhrases.push(randomPhrase);
                    }
                }
            } else {
                // Shuffle and pick 10 unique phrases
                shuffleArray(filteredPhrases);
                selectedPhrases = filteredPhrases.slice(0, TOTAL_FLASHCARDS);
            }
            return selectedPhrases;
        }

        function getQuizQuestionsForLevel(flashcards) {
            let questions = [];
            const shuffledFlashcards = shuffleArray([...flashcards]);

            // Create 10 questions from the 10 flashcards
            for (let i = 0; i < 10; i++) {
                const card = shuffledFlashcards[i];
                questions.push({
                    question: `Â¿CÃ³mo se dice "${card.es}"?`,
                    correct: card.en,
                    options: getQuizOptions(card.en, flashcards)
                });
            }

            // Create the remaining 2 questions by duplicating two random questions
            const twoMoreQuestions = shuffleArray(questions.slice(0, 10)).slice(0, 2);
            questions = shuffleArray([...questions, ...twoMoreQuestions]);

            return questions;
        }

        function getQuizOptions(correctAnswer, flashcards) {
            let options = [correctAnswer];
            const otherAnswers = flashcards.map(card => card.en).filter(en => en !== correctAnswer);
            
            shuffleArray(otherAnswers);
            options.push(...otherAnswers.slice(0, 3));
            return shuffleArray(options);
        }

        // --- End of core logic

        let db, auth, userId, progressUnsubscribe;

        let state = {
            currentView: 'start', // 'start', 'flashcard', 'quiz', 'completion'
            currentQuestionIndex: 0,
            correctAnswers: 0,
            level: 1,
            flashcardPhrases: [],
            quizQuestions: []
        };
        
        // Sound effects using Web Audio API
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        function playAudioFeedback(isCorrect) {
            if (!audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            if (isCorrect) {
                oscillator.type = 'sine';
                oscillator.frequency.value = 880; // A pleasant, high pitch
                gainNode.gain.value = 0.5;
            } else {
                oscillator.type = 'triangle';
                oscillator.frequency.value = 220; // A lower, more dissonant pitch
                gainNode.gain.value = 0.5;
            }
            
            const now = audioContext.currentTime;
            gainNode.gain.setValueAtTime(0.5, now);
            gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.5);
            
            oscillator.start(now);
            oscillator.stop(now + 0.5);
        }

        // UI references
        const startView = document.getElementById('startView');
        const flashcardView = document.getElementById('flashcardView');
        const quizView = document.getElementById('quizView');
        const completionView = document.getElementById('completionView');
        
        const cardGrid = document.getElementById('cardGrid');
        const startQuizButton = document.getElementById('startButton');

        const quizQuestionEl = document.getElementById('quizQuestion');
        const currentQuestionNumberEl = document.getElementById('currentQuestionNumber');
        const choicesEl = document.getElementById('choices');
        const quizProgressFill = document.getElementById('quizProgressFill');
        const quizProgressText = document.getElementById('quizProgressText');
        const scoreDisplay = document.getElementById('scoreDisplay');

        const completionTitleEl = document.getElementById('completionTitle');
        const completionMessageEl = document.getElementById('completionMessage');

        const levelTextEl = document.getElementById('levelText');
        const levelProgressFillEl = document.getElementById('levelProgressFill');
        const nextLevelButton = document.getElementById('nextLevelButton');
        const retryLevelButton = document.getElementById('retryLevelButton');

        // Firestore paths
        function getUserDocRef() {
            return doc(db, `/artifacts/${appId}/users/${userId}/coffeetalk_progress`, 'user_progress_v2');
        }

        async function saveProgress() {
            if (!db || !userId) {
                console.error("Database not initialized or user not authenticated.");
                return;
            }
            try {
                await setDoc(getUserDocRef(), {
                    level: state.level,
                    currentView: state.currentView,
                    correctAnswers: state.correctAnswers,
                    currentQuestionIndex: state.currentQuestionIndex,
                });
                console.log("Progress saved to Firestore.");
            } catch (e) {
                console.error("Error saving progress:", e);
            }
        }

        // Real-time data listener from Firestore
        function setupProgressListener() {
            if (progressUnsubscribe) {
                progressUnsubscribe();
            }
            if (!db || !userId) {
                return;
            }
            const docRef = getUserDocRef();
            progressUnsubscribe = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    state.level = data.level || 1;
                    state.currentView = data.currentView || 'start';
                    state.correctAnswers = data.correctAnswers || 0;
                    state.currentQuestionIndex = data.currentQuestionIndex || 0;
                } else {
                    console.log("No progress found, initializing new state.");
                }
                updateUI();
            }, (error) => {
                console.error("Error listening to progress data:", error);
            });
        }

        // UI state management
        function updateUI() {
            startView.classList.add('hidden');
            flashcardView.classList.add('hidden');
            quizView.classList.add('hidden');
            completionView.classList.add('hidden');
            
            // Update level progress bar
            const levelProgress = Math.round((state.level / TOTAL_LEVELS) * 100);
            levelProgressFillEl.style.width = levelProgress + '%';
            levelTextEl.textContent = `${state.level}`;
            
            if (state.currentView === 'start') {
                startView.classList.remove('hidden');
            } else if (state.currentView === 'flashcard') {
                state.flashcardPhrases = getFlashcardPhrasesForLevel(state.level);
                flashcardView.classList.remove('hidden');
                renderFlashcards();
            } else if (state.currentView === 'quiz') {
                if (state.currentQuestionIndex >= TOTAL_QUIZ_QUESTIONS) {
                    state.currentView = 'completion';
                    saveProgress();
                    updateUI();
                } else {
                    quizView.classList.remove('hidden');
                    renderQuizQuestion();
                }
            } else if (state.currentView === 'completion') {
                completionView.classList.remove('hidden');
                
                // Check pass/fail condition
                const passed = state.correctAnswers >= 11;
                
                if (passed) {
                    nextLevelButton.classList.remove('hidden');
                    retryLevelButton.classList.add('hidden');
                    completionTitleEl.textContent = "Â¡LecciÃ³n completada!";
                    const reward = REWARDS[state.level];
                    if (reward) {
                        completionMessageEl.textContent = reward;
                        scoreDisplay.style.display = 'none';
                    } else {
                        completionMessageEl.textContent = `Â¡Felicidades! Has pasado al siguiente nivel con una puntuaciÃ³n de ${state.correctAnswers}/12.`;
                        scoreDisplay.style.display = 'inline';
                        scoreDisplay.textContent = state.correctAnswers;
                    }
                } else {
                    nextLevelButton.classList.add('hidden');
                    retryLevelButton.classList.remove('hidden');
                    completionTitleEl.textContent = "Â¡IntÃ©ntalo de nuevo!";
                    completionMessageEl.textContent = `Tu puntuaciÃ³n es de ${state.correctAnswers}/12. Necesitas al menos 11 para pasar.`;
                    scoreDisplay.style.display = 'inline';
                    scoreDisplay.textContent = state.correctAnswers;
                }
            }
        }

        function renderFlashcards() {
            cardGrid.innerHTML = '';
            state.flashcardPhrases.forEach(card => {
                const cardHtml = `
                    <div class="card bg-gray-50 p-4 rounded-2xl flex flex-col justify-between">
                        <div>
                            <div class="text-xl font-bold text-gray-800 mb-1">${card.en}</div>
                            <div class="text-lg text-gray-500">${card.es}</div>
                        </div>
                        <div class="flex gap-2 mt-4">
                            <button class="px-3 py-2 rounded-xl text-white font-semibold btn-accent transition-all duration-200 hover:opacity-90" onclick="speak('${card.en}', 'en-US')">ðŸ”Š InglÃ©s</button>
                            <button class="px-3 py-2 rounded-xl text-orange-600 bg-transparent font-semibold btn-muted transition-all duration-200 hover:bg-orange-50" onclick="speak('${card.es}', 'es-ES')">ðŸ”‰ TraducciÃ³n</button>
                        </div>
                    </div>
                `;
                cardGrid.innerHTML += cardHtml;
            });
        }

        function renderQuizQuestion() {
            const questionData = state.quizQuestions[state.currentQuestionIndex];
            quizQuestionEl.textContent = questionData.question;
            currentQuestionNumberEl.textContent = state.currentQuestionIndex + 1;
            choicesEl.innerHTML = '';

            const shuffledOptions = shuffleArray(questionData.options);

            shuffledOptions.forEach(option => {
                const button = document.createElement('div');
                button.className = 'quiz-choice p-3 rounded-lg cursor-pointer bg-white border border-gray-100 transition-all duration-200 hover:bg-orange-50';
                button.textContent = option;
                button.onclick = () => checkQuizAnswer(button, option, questionData.correct);
                choicesEl.appendChild(button);
            });

            const progress = Math.round((state.currentQuestionIndex / TOTAL_QUIZ_QUESTIONS) * 100);
            quizProgressFill.style.width = progress + '%';
            quizProgressText.textContent = `${state.currentQuestionIndex}/${TOTAL_QUIZ_QUESTIONS}`;
        }

        async function checkQuizAnswer(button, selectedAnswer, correctAnswer) {
            Array.from(choicesEl.children).forEach(child => child.style.pointerEvents = 'none');
            
            if (selectedAnswer === correctAnswer) {
                button.classList.add('correct');
                playAudioFeedback(true);
                state.correctAnswers++;
            } else {
                button.classList.add('wrong');
                playAudioFeedback(false);
                Array.from(choicesEl.children).find(c => c.textContent === correctAnswer).classList.add('correct');
            }

            await saveProgress();
            
            setTimeout(() => {
                state.currentQuestionIndex++;
                state.currentView = 'quiz';
                saveProgress();
                updateUI();
            }, 1500); // Wait a bit longer to allow sound and visual to register
        }

        function nextLevel() {
            state.level++;
            state.currentView = 'start';
            state.currentQuestionIndex = 0;
            state.correctAnswers = 0;
            saveProgress();
            updateUI();
        }

        function retryLevel() {
            state.currentView = 'start';
            state.currentQuestionIndex = 0;
            state.correctAnswers = 0;
            saveProgress();
            updateUI();
        }

        // speech
        function speak(text, lang = 'en-US') {
            if ('speechSynthesis' in window) {
                const ut = new SpeechSynthesisUtterance(text);
                ut.lang = lang;
                ut.rate = 0.7; // Reduce the speech rate for better pronunciation practice
                speechSynthesis.cancel();
                speechSynthesis.speak(ut);
            } else {
                console.warn('Speech synthesis not supported on this browser.');
            }
        }

        // Global speak function
        window.speak = speak;

        // Event listeners
        document.getElementById('startButton').addEventListener('click', () => {
            state.currentView = 'flashcard';
            saveProgress();
            updateUI();
        });

        document.getElementById('startQuizButton').addEventListener('click', () => {
            state.quizQuestions = getQuizQuestionsForLevel(state.flashcardPhrases);
            state.currentView = 'quiz';
            state.currentQuestionIndex = 0;
            state.correctAnswers = 0;
            saveProgress();
            updateUI();
        });
        
        document.getElementById('nextLevelButton').addEventListener('click', nextLevel);
        document.getElementById('retryLevelButton').addEventListener('click', retryLevel);

        // Initialize Firebase and Auth
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    setupProgressListener();
                } else {
                    console.log("Signing in...");
                    if (initialAuthToken) {
                        try {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } catch (error) {
                            console.error("Error signing in with custom token:", error);
                            await signInAnonymously(auth);
                        }
                    } else {
                        await signInAnonymously(auth);
                    }
                }
            });
        } catch (e) {
            console.error("Error initializing Firebase:", e);
        }
    </script>
</body>
</html>
